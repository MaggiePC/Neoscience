<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DART Kids ‚Äî Protege la Tierra</title>
<style>
  :root{--bg:#071423;--fg:#eaf2ff;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--ui:#94a3b8}
  *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  body{
    margin:0;
    background-image:url('fondojuego.png');
    background-size:cover;
    background-repeat:no-repeat;
    background-position:center center;
    color:var(--fg);
    overflow:hidden;
  }
  header{
    position:fixed;left:12px;top:12px;background:#0008;border:1px solid #ffffff22;border-radius:14px;
    padding:8px 12px;font-size:25px;backdrop-filter:blur(4px);z-index:2
  }
  header b{color:#a5b4fc}
  .panel{position:fixed;right:12px;top:12px;display:flex;gap:8px;z-index:2}
  .btn{background:#ffffff1a;border:1px solid #ffffff33;color:var(--fg);padding:8px 12px;border-radius:12px;cursor:pointer;font-size:18px}
  .btn:active{transform:scale(0.98)}
  .btn-exit{background:#ef44441a;border:1px solid #ef444455}
  canvas{display:block;width:100vw;height:100vh}
  .touch{position:fixed;inset:auto 0 10px 0;display:flex;justify-content:center;gap:10px;z-index:2}
  .pad{background:#ffffff12;border:1px solid #ffffff22;color:var(--fg);width:70px;height:70px;border-radius:16px;font-size:22px;display:grid;place-items:center;user-select:none}
  .shoot{width:120px}
  .banner{position:fixed;left:50%;top:12%;transform:translateX(-50%);background:#000b;border:1px solid #ffffff33;border-radius:12px;padding:10px 16px;font-size:16px;z-index:2;display:none}
  .intro-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(3px);display:flex;align-items:center;justify-content:center;z-index:5}
  .intro-card{width:min(860px,92vw);max-height:86vh;overflow:auto;background:#0b1630;border:1px solid #3b425a;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .intro-card h1{margin:0 0 8px;font-size:22px;color:#a5b4fc}
  .intro-grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
  .intro-section{background:#0d1e3e;border:1px solid #2a3656;border-radius:12px;padding:12px}
  .intro-section h2{margin:0 0 6px;font-size:16px;color:#9bd1ff}
  .intro-list{margin:8px 0 0;padding-left:18px;line-height:1.5;font-size:14px}
  .kbd{display:inline-block;background:#0f172a;border:1px solid #334155;border-radius:8px;padding:2px 6px;font-family:ui-monospace, SFMono-Regular, Menlo, monospace}
  .intro-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
  .btn-cta{background:#22c55e;border:0;color:#0b1020;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
  .intro-footer{display:flex;justify-content:space-between;align-items:center;margin-top:6px;font-size:12px;color:#cbd5e1}
  .intro-footer label{display:flex;gap:8px;align-items:center;cursor:pointer}
  @media (max-width: 840px){ .intro-grid{grid-template-columns:1fr} }
  .hidden{display:none !important}
</style>
</head>
<body>
<header>
  <div><b>DART Kids</b> üöÄ ¬°Protege la Tierra!</div>
  <div id="hud" style="font-size:25px">Puntos: 0 ¬∑ Mejor: 0 ¬∑ Vidas: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è ¬∑ Nivel: 1</div>
</header>

<div class="panel">
  <button class="btn" id="btnRestart">Reiniciar</button>
  <button class="btn" id="btnHelp">¬øC√≥mo jugar?</button>
  <button class="btn btn-exit" id="btnExit" title="Salir (ESC)">Salir</button>
</div>

<div class="touch" id="touchCtrls" style="display:none">
  <div class="pad" data-dir="-1">‚üµ</div>
  <div class="pad shoot" id="shootBtn">DISPARAR</div>
  <div class="pad" data-dir="1">‚ü∂</div>
</div>

<div class="banner" id="banner"></div>

<div id="intro" class="intro-backdrop hidden">
  <div class="intro-card">
    <h1>¬øQu√© fue la misi√≥n <b>DART</b>?</h1>
    <div class="intro-grid">
      <section class="intro-section">
        <h2>Resumen</h2>
        <p style="margin:6px 0 0;font-size:14px;line-height:1.55">
          DART prob√≥ desviar un asteroide con un <b>impacto cin√©tico</b>. Cambios peque√±itos en velocidad ‚Üí grandes cambios en trayectoria. üåç
        </p>
        <ul class="intro-list">
          <li><span class="kbd">‚Üê</span>/<span class="kbd">‚Üí</span> mover</li>
          <li><span class="kbd">Espacio</span> disparar</li>
          <li><span class="kbd">R</span> reiniciar ¬∑ <span class="kbd">H</span> ayuda ¬∑ <span class="kbd">P</span> pausar ¬∑ <span class="kbd">ESC</span> salir</li>
        </ul>
      </section>
      <section class="intro-section">
        <h2>Consejo</h2>
        <p style="margin:6px 0 0;font-size:14px;line-height:1.55">Evita que crucen la atm√≥sfera; si tocan la Tierra, pierdes una vida.</p>
      </section>
    </div>
    <div class="intro-actions">
      <button class="btn-cta" id="btnPlay">¬°Jugar!</button>
      <button class="btn" id="btnExitIntro">Salir</button>
    </div>
    <div class="intro-footer">
      <label><input type="checkbox" id="chkSkipIntro"> No mostrar esta intro la pr√≥xima vez</label>
      <small>Tip: tienes 5 vidas.</small>
    </div>
  </div>
</div>

<canvas id="game"></canvas>

<script>
(() => {
  // ===== Storage seguro =====
  const storage = (() => {
    try { const t='__test__'; localStorage.setItem(t,'1'); localStorage.removeItem(t); return localStorage; }
    catch { const m=new Map(); return { getItem:k=>m.has(k)?m.get(k):null, setItem:(k,v)=>m.set(k,String(v)), removeItem:k=>m.delete(k) }; }
  })();

  // ===== Salir a la app (postMessage + fallback) =====
  function exitToApp(route = "/") {
    try {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: "GO_STORY", action: "go", route }, "*");
      } else {
        window.location.href = route;
      }
    } catch {
      window.location.href = route;
    }
  }
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') exitToApp('/'); });

  // ----- Canvas / escala -----
  const DPR = Math.max(1, devicePixelRatio||1);
  /** @type {HTMLCanvasElement} */ const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  let CW, CH;

  // ===== Geometr√≠a Tierra =====
  const EARTH = { cx: 0, cy: 0, R: 0 };
  function computeEarthGeom(){ EARTH.cx=CW/2; EARTH.cy=CH+120*DPR; EARTH.R=CH*0.60; }
  function resize(){ canvas.width=CW=innerWidth*DPR; canvas.height=CH=innerHeight*DPR; canvas.style.width=innerWidth+'px'; canvas.style.height=innerHeight+'px'; computeEarthGeom(); }
  resize(); addEventListener('resize', resize);

  // ===== Sprites asteroides =====
  const ASTEROID_STYLE = 'sprite';
  function loadAst(src){ const img=new Image(); img.src=src; img.ready=false; img.onload=()=>img.ready=true; return img; }
  const asteroidImgs = {
    metal:   loadAst('asteroideMetalico.png'),
    ice:     loadAst('asteroideHielo.png'),
    volcano: loadAst('asteroideVolcan.png')
  };
  const AST_WEIGHTS = { metal:0.4, ice:0.3, volcano:0.3 };
  function pickAsteroidType(){ const r=Math.random(), a=AST_WEIGHTS.metal, b=a+AST_WEIGHTS.ice; return r<a?'metal':(r<b?'ice':'volcano'); }

  // ----- UI (JS + JSDoc) -----
  /** @type {HTMLDivElement|null} */ const hud = document.getElementById('hud');
  /** @type {HTMLDivElement|null} */ const banner = document.getElementById('banner');
  /** @type {HTMLButtonElement|null} */ const btnRestart = document.getElementById('btnRestart');
  /** @type {HTMLButtonElement|null} */ const btnHelp = document.getElementById('btnHelp');
  /** @type {HTMLButtonElement|null} */ const btnExit = document.getElementById('btnExit');
  /** @type {HTMLDivElement|null} */ const touchCtrls = document.getElementById('touchCtrls');
  /** @type {HTMLDivElement|null} */ const shootBtn = document.getElementById('shootBtn');
  /** @type {HTMLDivElement|null} */ const introEl = document.getElementById('intro');
  /** @type {HTMLButtonElement|null} */ const btnPlay = document.getElementById('btnPlay');
  /** @type {HTMLButtonElement|null} */ const btnExitIntro = document.getElementById('btnExitIntro');
  /** @type {HTMLInputElement|null} */ const chkSkipIntro = document.getElementById('chkSkipIntro');

  if ((innerWidth < 900 || 'ontouchstart' in window) && touchCtrls) touchCtrls.style.display = 'flex';
  btnExit?.addEventListener('click', () => exitToApp('/'));
  btnExitIntro?.addEventListener('click', () => exitToApp('/'));

  function showBanner(text, ms=1800){
    if (!banner) return;
    banner.textContent = text; banner.style.display = 'block';
    clearTimeout(showBanner._t); showBanner._t = setTimeout(()=>{ if(banner) banner.style.display='none'; }, ms);
  }

  // ===== Tierra textura =====
  const earthTex = new Image(); let earthReady=false; earthTex.src='earth_texture.png'; earthTex.onload=()=>earthReady=true;
  function earthTopYAt(x){ const dx=x-EARTH.cx; if (Math.abs(dx)>EARTH.R) return Infinity; return EARTH.cy - Math.sqrt(EARTH.R*EARTH.R - dx*dx); }

  // ----- Juego -----
  const state = {
    ship:{x:0,y:0,w:44*DPR,h:44*DPR,speed:7*DPR,cooldown:0},
    bullets:[], rocks:[], particles:[],
    score:0, lives:5, level:1, over:false, shake:0, earthAngle:0
  };
  let paused=false;

  function updateHUD(){
    if (!hud) return;
    const total=5, hearts='‚ù§Ô∏è'.repeat(state.lives)+'ü§ç'.repeat(Math.max(0,total-state.lives));
    hud.textContent=`Puntos: ${state.score} ¬∑ Mejor: ${best} ¬∑ Vidas: ${hearts} ¬∑ Nivel: ${state.level}`;
  }

  const BEST_KEY='dartkids_best', SKIP_INTRO_KEY='dartkids_skip_intro';
  let best=Number(storage.getItem(BEST_KEY))||0;

  function reset(){
    state.ship.x=CW/2; state.ship.y=CH-140*DPR;
    state.bullets=[]; state.rocks=[]; state.particles=[];
    state.score=0; state.lives=5; state.level=1; state.over=false; state.shake=0; state.earthAngle=0;
    spawnWave(); updateHUD(); showBanner('Mueve la nave ¬∑ Dispara a los asteroides ¬∑ ¬°Protege la Tierra! üåç');
  }

  // Spawns
  function spawnWave(){ const n=4+state.level; for (let i=0;i<n;i++) state.rocks.push(newRock()); }
  function newRock(){
    const size=Math.random()*18*DPR+22*DPR;
    const range=EARTH.R*0.9, x=EARTH.cx+(Math.random()*2-1)*range, y=-50*DPR - Math.random()*300*DPR;
    const speed=(1.0+state.level*0.25)*DPR;
    const drift=((EARTH.cx-x)/EARTH.R)*0.35*DPR + (Math.random()*0.30 - 0.15)*DPR;
    const rot=Math.random()*Math.PI*2, rotSpeed=(Math.random()*0.8-0.4)*0.01;
    const shape=makeRockShape(size, Math.floor(8+Math.random()*6));
    const hue=Math.max(200-state.level*8,160), color=`hsl(${hue} 24% 35%)`;
    const type=pickAsteroidType();
    return { x,y,r:size,vy:speed,vx:drift,hit:false,rot,rotSpeed,shape,color,type };
  }
  function makeRockShape(radius, sides){
    const pts=[]; for (let i=0;i<sides;i++){ const a=i/sides*Math.PI*2, w=0.72+Math.random()*0.5; pts.push({x:Math.cos(a)*radius*w,y:Math.sin(a)*radius*w}); } return pts;
  }

  // Entrada
  const keys=new Set();
  addEventListener('keydown', e=>{
    if (e.key===' '||e.code==='Space'){ shoot(); e.preventDefault(); }
    if (e.key.toLowerCase()==='p') paused=!paused;
    if (e.key.toLowerCase()==='r') reset();
    if (e.key.toLowerCase()==='h') showIntro(true);
    keys.add(e.key);
  });
  addEventListener('keyup', e=>keys.delete(e.key));

  let touchDir=0, pressShoot=false;
  touchCtrls?.addEventListener('touchstart', e=>{
    const t = /** @type {HTMLElement} */(e.target);
    if (t?.classList.contains('pad') && t.dataset.dir) touchDir=parseInt(t.dataset.dir,10);
    if (t===shootBtn){ pressShoot=true; shoot(); }
  }, {passive:true});
  touchCtrls?.addEventListener('touchend', ()=>{ touchDir=0; pressShoot=false; }, {passive:true});

  // Disparo
  function shoot(){
    if (state.over||paused) return;
    if (state.ship.cooldown>0) return;
    const b={x:state.ship.x,y:state.ship.y - state.ship.h*0.6,vy:-12*DPR};
    state.bullets.push(b); state.ship.cooldown=10;
    for (let i=0;i<6;i++) state.particles.push(particle(b.x,b.y,1));
  }

  // Part√≠culas
  function particle(x,y,mode=0){
    const a=Math.random()*Math.PI*2, s=(mode?3:2)*DPR + Math.random()*1*DPR;
    return { x,y, vx:Math.cos(a)*s, vy:Math.sin(a)*s, life:20, color: mode? '#cbd5e1' : '#f59e0b' };
  }

  // F√≠sica
  function update(){
    let dir=0;
    if (keys.has('ArrowLeft')||keys.has('a')) dir-=1;
    if (keys.has('ArrowRight')||keys.has('d')) dir+=1;
    if (touchDir!==0) dir=touchDir;
    state.ship.x += dir*state.ship.speed*(state.over?0:1);
    state.ship.x = Math.max(40*DPR, Math.min(CW-40*DPR, state.ship.x));
    if (state.ship.cooldown>0) state.ship.cooldown--;

    state.earthAngle += 0.003;

    for (let i=state.bullets.length-1;i>=0;i--){
      const b=state.bullets[i]; b.y += b.vy; if (b.y < -40*DPR) state.bullets.splice(i,1);
    }

    if (!state.over){ for (let r of state.rocks){ r.y += r.vy; r.x += r.vx; r.rot += r.rotSpeed; } }

    for (let i=state.rocks.length-1;i>=0;i--){
      const r=state.rocks[i];
      for (let j=state.bullets.length-1;j>=0;j--){
        const b=state.bullets[j], dx=r.x-b.x, dy=r.y-b.y;
        if (dx*dx+dy*dy < (r.r*0.8)*(r.r*0.8)){ hitRock(r); state.rocks.splice(i,1); state.bullets.splice(j,1); state.score+=10; updateHUD(); break; }
      }
    }

    for (let i=state.rocks.length-1;i>=0;i--){
      const r=state.rocks[i], yArc=earthTopYAt(r.x);
      if (r.y + r.r > yArc){ state.rocks.splice(i,1); damageEarth(); }
    }

    if (!state.over && state.rocks.length===0){ state.level++; spawnWave(); showBanner(`Nivel ${state.level} ‚Üë`,1200); updateHUD(); }
    if (state.shake>0) state.shake--;
  }

  function hitRock(r){
    for (let k=0;k<16;k++){ const p=particle(r.x,r.y,1); p.vx*=1.5; p.vy*=1.5; p.life=26; state.particles.push(p); }
  }

  function damageEarth(){
    state.lives--; state.shake=14; updateHUD();
    if (state.lives<=0){
      state.over=true;
      if (state.score>best){ best=state.score; storage.setItem(BEST_KEY,String(best)); showBanner(`üéâ ¬°Nuevo r√©cord! ${best} puntos`); }
      else { showBanner(`Juego terminado ¬∑ Puntos: ${state.score} ¬∑ Nivel: ${state.level}`); }
    } else { showBanner('¬°Cuidado! Un asteroide toc√≥ la Tierra üò¨',1400); }
  }

  // Dibujo
  function draw(){
    const ox=(state.shake?(Math.random()-0.5)*6*DPR:0), oy=(state.shake?(Math.random()-0.5)*6*DPR:0);
    ctx.setTransform(1,0,0,1,ox,oy); ctx.clearRect(-ox,-oy,CW,CH);

    ctx.fillStyle='#ffffff18'; for (let i=0;i<60;i++){ const x=((i*73)%CW), y=((i*131)%CH); ctx.fillRect(x,y,2,2); }

    drawEarth(); drawShip(); drawBullets(); drawRocks(); drawParticles();
  }

  function drawEarth(){
    const { cx, cy, R } = EARTH;
    ctx.save(); ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.clip();
    if (earthReady){
      ctx.translate(cx,cy); ctx.rotate(state.earthAngle);
      const S=R*2.2; ctx.drawImage(earthTex,-S/2,-S/2,S,S); ctx.setTransform(1,0,0,1,0,0);
    } else {
      const g=ctx.createRadialGradient(cx-R/4, cy-R/4, R*.5, cx, cy, R);
      g.addColorStop(0,'#1d4ed8'); g.addColorStop(1,'#0c4a6e'); ctx.fillStyle=g; ctx.fillRect(cx-R, cy-R, R*2, R*2);
    }
    ctx.restore();
    ctx.beginPath(); ctx.arc(cx,cy,R*1.02,0,Math.PI*2); ctx.fillStyle='rgba(96,165,250,0.04)'; ctx.fill();
  }

  function drawRocks(){
    for (const r of state.rocks){
      if (ASTEROID_STYLE==='sprite'){
        const tex = asteroidImgs[r.type];
        if (tex && tex.ready){
          ctx.save(); ctx.translate(r.x,r.y); ctx.rotate(r.rot);
          const s=r.r*2; ctx.drawImage(tex,-s/2,-s/2,s,s); ctx.restore();
        } else {
          ctx.save(); ctx.translate(r.x,r.y); ctx.rotate(r.rot);
          ctx.beginPath(); for (let i=0;i<r.shape.length;i++){ const p=r.shape[i]; i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y); }
          ctx.closePath(); ctx.fillStyle=r.color; ctx.fill(); ctx.lineWidth=2*DPR; ctx.strokeStyle='#93c5fd66'; ctx.stroke(); ctx.restore();
        }
      } else {
        ctx.beginPath(); ctx.arc(r.x,r.y,r.r,0,Math.PI*2); ctx.fillStyle='#334155'; ctx.fill(); ctx.strokeStyle='#93c5fd88'; ctx.lineWidth=2*DPR; ctx.stroke();
      }
      ctx.beginPath(); ctx.moveTo(r.x, r.y - r.r - 10*DPR); ctx.lineTo(r.x, r.y - r.r - 26*DPR);
      ctx.strokeStyle='#f59e0b88'; ctx.lineWidth=2*DPR; ctx.stroke();
    }
  }

  function drawShip(){
    const s=state.ship;
    ctx.save(); ctx.translate(s.x,s.y);
    ctx.beginPath(); ctx.moveTo(0,-s.h*0.6); ctx.lineTo(s.w*0.35,s.h*0.4); ctx.lineTo(-s.w*0.35,s.h*0.4); ctx.closePath(); ctx.fillStyle='#e5e7eb'; ctx.fill();
    if (!state.over && !paused){
      ctx.beginPath(); ctx.moveTo(0,s.h*0.42); ctx.lineTo(6*DPR,s.h*0.65); ctx.lineTo(-6*DPR,s.h*0.65); ctx.closePath(); ctx.fillStyle='#f59e0b'; ctx.fill();
    }
    ctx.restore();
  }

  function drawBullets(){ ctx.strokeStyle='#a7f3d0'; ctx.lineWidth=3*DPR; for (const b of state.bullets){ ctx.beginPath(); ctx.moveTo(b.x,b.y); ctx.lineTo(b.x,b.y-14*DPR); ctx.stroke(); } }

  function drawParticles(){
    for (let i=state.particles.length-1;i>=0;i--){
      const p=state.particles[i]; p.x+=p.vx; p.y+=p.vy; p.life--;
      if (p.life<=0){ state.particles.splice(i,1); continue; }
      ctx.globalAlpha=Math.max(0,p.life/26); ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,3*DPR,3*DPR); ctx.globalAlpha=1;
    }
  }

  // Intro
  function showIntro(){ paused=true; if (chkSkipIntro) chkSkipIntro.checked = storage.getItem('dartkids_skip_intro')==='1'; introEl?.classList.remove('hidden'); }
  function hideIntro(){ introEl?.classList.add('hidden'); paused=false; }
  btnPlay?.addEventListener('click', ()=>{ if (chkSkipIntro?.checked) storage.setItem('dartkids_skip_intro','1'); else storage.removeItem('dartkids_skip_intro'); hideIntro(); });
  introEl?.addEventListener('click', (e)=>{ if(e.target===introEl) hideIntro(); });

  btnRestart?.addEventListener('click', reset);
  btnHelp?.addEventListener('click', () => showIntro());

  // Bucle
  let last=performance.now();
  function loop(now){ const dt=Math.min(0.033,(now-last)/1000); last=now; if (!state.over && !paused) update(dt); draw(); requestAnimationFrame(loop); }

  // Inicio
  reset();
  if (storage.getItem('dartkids_skip_intro')!=='1') showIntro();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
